<link href="../../../output.css" rel="stylesheet"/>

<style>
  .liTransa {
    color: black;
    font-weight: bold;
    height: 13dvh;
    background: rgba(255, 255, 255, 0.873);
    box-shadow: 5px 5px 5px 5px rgb(143, 143, 143);
    border-radius: 0.5rem;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .btn {
    flex: 1;
    color: black;
    font-weight: bold;
    height: 10dvh;
    background: rgba(255, 255, 255, 0.873);
    box-shadow: 5px 5px 5px 5px rgb(143, 143, 143);
    border-radius: 0.5rem;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    margin: 0.5rem;
    gap: .5rem;
  }
  .btn img { width: 22px; height: 22px; }
</style>

<main class="bg-gradient-to-r from-gray-600 to-gray-800 p-1">
  <div class="max-w-6xl mx-auto m-5">

    <div class="flex flex-col lg:flex-row gap-4">
      <div class="flex justify-center rounded-lg border border-gray-200 bg-white shadow-md items-center p-6 lg:w-1/3">
        <img src="e-cityLogo.png" alt="logo1cero1" />
      </div>

      <div class="bg-white rounded-lg shadow-md p-4 flex-1 text-black">
        <div class="flex justify-between h-full">
          <button type="button" (click)="Charts()" class="cursor-pointer flex-1 text-white font-bold bg-gradient-to-r from-gray-600 to-gray-800 rounded-lg flex flex-col items-center justify-center p-4 m-2">
            <i class="fas fa-hand-holding-usd text-white text-4xl"></i>
            <p class="mt-2">Ver Gráficas</p>
          </button>

          <button type="button" (click)="verMapa()" class="cursor-pointer flex-1 text-white font-bold bg-gradient-to-r from-gray-600 to-gray-800 rounded-lg flex flex-col items-center justify-center p-4 m-2">
            <i class="fas fa-exchange-alt text-white text-4xl"></i>
            <p class="mt-2">Ver Mapa</p>
          </button>

          <button type="button" (click)="Exit()" class="cursor-pointer flex-1 text-white font-bold bg-gradient-to-r from-gray-600 to-gray-800 rounded-lg flex flex-col items-center justify-center p-4 m-2">
            <i class="fas fa-qrcode text-4xl"></i>
            <p class="mt-2">Cerrar Sesión</p>
          </button>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg p-4 shadow-md my-6 m-10">
      <h2 class="text-lg font-bold text-gray-600 mb-4">
        Transacciones
        @if (selectedPayPad()) {
          — {{ selectedPayPad()!.username }} (ID: {{ selectedPayPad()!.id }})
        }
      </h2>

      @if (loading()) {
        <p class="text-gray-500">Cargando...</p>
      } @else if (error()) {
        <p class="text-red-600">{{ error() }}</p>
      } @else if (!selectedPayPad()) {
        <p class="text-gray-500">Selecciona un punto en el mapa para ver el detalle.</p>
      } @else {
        <table class="w-full">
          <tbody>
            <tr class="border-b text-xs sm:text-lg xl:text-lg">
              <td class="px-4 py-2 text-left">
                <div>
                  <h2>Total Transacciones</h2>
                  @if (filteredTransactions().length) {
                    <p>{{ filteredTransactions()[0].dateCreated | date:'dd/MM/yyyy' }}</p>
                  } @else {
                    <p>-</p>
                  }
                </div>
              </td>
              <td class="px-4 py-2 text-right text-black font-bold rounded-4xl">
                <div class="p-2 text-center text-amber-50 font-bold flex flex-wrap justify-center md:justify-evenly gap-1.5">
                  <p class="bg-amber-500 rounded-xl p-3 w-full sm:w-auto">Total: {{ totalTransacciones() }} </p>
                  <p class="bg-red-500 rounded-xl p-3 w-full sm:w-auto">Canceladas: {{ cantCancelada }}</p>
                  <p class="bg-green-500 rounded-xl p-3 w-full sm:w-auto">Aprobadas: {{ cantAprobada }}</p>
                  <p class="bg-blue-500 rounded-xl p-3 w-full sm:w-auto">Iniciadas: {{ cantIniciada }}</p>
                </div>
              </td>
            </tr>

            <tr class="border-b text-xs sm:text-lg xl:text-lg">
              <td class="px-4 py-2 text-left">
                <div>
                  <h2>Total Recaudado</h2>
                  @if (filteredTransactions().length) {
                    <p>{{ filteredTransactions()[0].dateCreated | date:'dd/MM/yyyy' }}</p>
                  } @else {
                    <p>-</p>
                  }
                </div>
              </td>
              <td class="px-4 py-2 text-right font-bold">
                <span>{{ totalAmount | currency }}</span>
              </td>
            </tr>

            <tr class="text-xs sm:text-lg xl:text-lg">
              <td class="px-4 py-2 text-left">
                <div>
                  <h2>Total Retirado</h2>
                  @if (filteredTransactions().length) {
                    <p>{{ filteredTransactions()[0].dateCreated | date:'dd/MM/yyyy' }}</p>
                  } @else {
                    <p>-</p>
                  }
                </div>
              </td>
              <td class="px-4 py-2 text-right font-bold">
                <span>{{ totalRetirado() | currency }}</span>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="mt-4 sm:text-2xl xl:text-2xl">
          <h3 class="font-semibold text-gray-700 mb-8">Últimas transacciones</h3>
          @if (filteredTransactions().length === 0) {
            <p class="text-gray-500"><i>Sin transacciones</i></p>
          } @else {
            <ul class="text-xs xl:text-lg">
              @for (t of filteredTransactions().slice(0, 5); track t.id) {
                <li class="border-b liTransa">
                  <div>
                    <div class="font-medium">
                      #{{ t.id }} · {{ t.typeTransaction }} · {{ t.stateTransaction }}
                    </div>
                    <div class="text-gray-500">
                      {{ t.dateCreated | date:'dd/MM/yyyy HH:mm' }} · {{ t.product }} · Ref: {{ t.reference }}
                    </div>
                  </div>
                  <div>
                    <div class="text-cyan-600 font-semibold">
                      + {{ t.incomeAmount | currency }}
                    </div>
                    @if (t.returnAmount > 0) {
                      <div class="text-rose-600 font-semibold">
                        - {{ t.returnAmount | currency }}
                      </div>
                    }
                  </div>
                </li>
              }
            </ul>
          }
        </div>
      }
    </div>
  </div>
</main>

<!-- MAPA -->
<div id="map" style="height: 80vh;" class="border-3 w-[80%] rounded-t-4xl m-10 mb-0 flex justify-center bg-transparent shadow-2xl"></div>

<!-- ESTADOS -->
<div class="flex-1 text-white font-bold bg-gradient-to-r from-gray-600 to-gray-800 rounded-b-4xl flex flex-col items-center justify-center p-4 m-10 mt-0">
  <i class="fas fa-hand-holding-usd text-white text-4xl">Estados</i>
  <p class="mt-2"></p>
</div>

<div class="flex-1 text-black bg-white rounded-lg flex flex-col items-center justify-center p-4 m-2">
  <div class="grid-cols-1 align-middle text-center items-center font-bold flex row-auto flex-wrap">
    <button type="button" class="btn" (click)="setState(-1)">
      <img src="https://maps.google.com/mapfiles/ms/icons/blue.png" alt="Todas"><p>Todas</p>
    </button>
    <button type="button" class="btn" (click)="setState(1)">
      <img src="https://maps.google.com/mapfiles/ms/icons/green.png" alt="Activas"><p>Activas</p>
    </button>
    <button type="button" class="btn" (click)="setState(2)">
      <img src="https://maps.google.com/mapfiles/ms/icons/yellow.png" alt="Periférico"><p>Periférico Desconectado</p>
    </button>
    <button type="button" class="btn" (click)="setState(0)">
      <img src="https://maps.google.com/mapfiles/ms/icons/red.png" alt="Apagadas"><p>Apagadas</p>
    </button>
    <button type="button" class="btn" (click)="setState(3)">
      <img src="https://maps.google.com/mapfiles/ms/icons/purple.png" alt="Sin Internet"><p>Sin Internet</p>
    </button>
    <button type="button" class="btn" (click)="setState(4)">
      <img src="https://maps.google.com/mapfiles/ms/icons/grey.png" alt="Sin Dinero"><p>Sin Dinero</p>
    </button>
  </div>
</div>

<footer style="height: 10vh;" class="w-full bg-gradient-to-r from-gray-600 to-gray-800 flex justify-center">
  <p class="mt-6 text-xs leading-5 text-gray-100 text-center">
    © {{ _currentYear }} - E-city software - Creado por
    <a href="https://www.1cero1.com/" class="font-medium text-white underline">1cero1 Software</a>
  </p>
</footer>